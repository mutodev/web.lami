<!-- ITEMS LIST-->
<div [formGroup]="formGroup">
    <div class="grid grid-row-3">

        <!-- ADD ITEM BUTTON -->
        <div class="gap-x-4 text-lg font-medium mb-5">
            <button class="w-full md:w-auto " (click)="addItemRowBtn()" mat-stroked-button [color]="'primary'">
                <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                <span class="ml-2 mr-1">Agregar artículo</span>
            </button>
        </div>


        <!-- HEADER ITEMS-->
        <div class="list-grid p-3 hidden md:grid items-center gap-x-4 text-white  bg-zinc-500">
            <div class="font-medium text-md">Descripción</div>
            <div class="font-medium text-md text-center">Desc %</div>
            <div class="font-medium text-md text-center">Cant.</div>
            <div class="font-medium text-md text-center">Proyecto</div>
            <div class="font-medium text-md text-center">Imp.</div>
            <!-- <div class="col-span-1 font-medium text-md text-left">Cantidad</div> -->
            <div class="font-medium text-md text-right">Precio</div>
            <div class="font-medium text-md text-right">Total</div>
            <div class="font-medium text-md text-left"></div>
        </div>
        <!-- Body ITEMS-->


        <!-- Items Array -->
        <ng-container *ngFor="let item of items.controls; let i=index">
            <div class="list-grid grid  mt-1  gap-x-4 items-center border-b py-2 md:px-3" formArrayName="items">
                <ng-container [formGroup]="item">
                    <!-- Items -->
                    <div class="text-base font-medium">

                        <div class="font-semibold">{{ item.get('code').value }}</div>
                        <div class="text-secondary">{{ item.get('name').value }}</div>

                    </div>

                    <!-- Desc -->
                    <div class="self-center text-left hidden md:block">
                        <mat-form-field floatLabel="never" appearance="legacy" class="w-full fuse-mat-dense">
                            <input type="number" min="0" formControlName="discount" [placeholder]="'Desc%'" matInput>
                        </mat-form-field>
                    </div>

                    <!-- Cantidad -->
                    <div class="self-center text-left hidden md:block">
                        <mat-form-field floatLabel="never" appearance="legacy" class="w-full fuse-mat-dense">
                            <input type="number" min="1" formControlName="quantity" class="text-center" matInput>
                        </mat-form-field>
                    </div>


                    <!-- PROJECT -->
                    <div class="self-center text-left hidden md:block">
                        <mat-form-field floatLabel="never" appearance="legacy" class="w-full fuse-mat-dense">
                            <mat-select formControlName="project" [placeholder]="'Proyecto'">
                                <mat-option *ngFor="let project of projects" [value]="project.code">{{project.name}}
                                </mat-option>
                            </mat-select>

                        </mat-form-field>
                    </div>

                    <!-- iva -->
                    <div class="self-center text-left hidden md:block">
                        <mat-form-field floatLabel="never" appearance="legacy" class="w-full fuse-mat-dense">
                            <mat-select formControlName="tax" [placeholder]="'Impuesto'">
                                <mat-option class="text-sm" *ngFor="let tax of taxes" [value]="tax.code">{{tax.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <!-- price -->
                    <div class="self-center text-right border-nonet hidden md:block">
                        <div class="font-semibold text-lg">{{ item.get('price').value | currency }}</div>
                    </div>

                    <!-- Total -->
                    <div class="self-center text-right hidden md:block">
                        <div class="font-semibold text-lg">{{ item.get('total').value | currency }}</div>
                    </div>
                    <div class="self-center text-right  hidden md:block">
                        <button (click)="removeItemRowBtn(i)" mat-button>
                            <mat-icon class="text-gray-400 icon-size-5" [svgIcon]="'heroicons_solid:x'">
                            </mat-icon>
                        </button>
                    </div>
                    <!-- Details button -->

                    <button type="button" class="min-w-10 md:hidden min-h-7 h-7 px-2 leading-6" mat-stroked-button
                        (click)="toggleDetails(item.get('id'))">
                        <mat-icon class="icon-size-5"
                            [svgIcon]="selectedProduct === item.id  ? 'heroicons_solid:chevron-up' : 'heroicons_solid:chevron-down'">
                        </mat-icon>
                    </button>

                    <div class="grid col-span-2">
                        <ng-container *ngIf="selectedProduct === item.get('id')">
                            <ng-container *ngTemplateOutlet="rowDetailsTemplate; context: {$implicit: item}">
                            </ng-container>
                        </ng-container>
                    </div>

                </ng-container>

            </div>
        </ng-container>

        <ng-template #rowDetailsTemplate let-item>
            <div class="overflow-hidden">
                    <!-- Selected product form -->
                    <!-- <ng-container *ngFor="let item of items.controls; let i=index"> -->
                        <ng-container [formGroup]="item">
                            <div class="px-5 py-3">
                                <!-- ROW 1 -->
                                <div class="flex  justify-between">
                                    <div>
                                        <mat-form-field floatLabel="float" appearance="legacy"
                                            class="w-full fuse-mat-dense">
                                            <input type="number" min="0" formControlName="discount"
                                                [placeholder]="'Descuento %'" matInput>
                                        </mat-form-field>
                                    </div>
                                    <div>
                                        <mat-form-field floatLabel="float" appearance="legacy"
                                            class="w-full fuse-mat-dense">
                                            <input type="number" min="1" [placeholder]="'Cantidad'"
                                                formControlName="quantity"  matInput>
                                        </mat-form-field>
                                    </div>
                                </div>
                                <!-- ROW 2 -->
                                <div class="flex w-full">
                                    <mat-form-field floatLabel="float" appearance="legacy" class="w-full fuse-mat-dense">
                                        <mat-select formControlName="project" [placeholder]="'Proyecto'">
                                            <mat-option *ngFor="let project of projects" [value]="project.code">{{project.name}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                 <!-- ROW 3 -->
                                 <div class="flex w-full">
                                    <mat-form-field floatLabel="float" appearance="legacy" class="w-full fuse-mat-dense">
                                        <mat-select formControlName="tax" [placeholder]="'Impuesto'">
                                            <mat-option class="text-sm" *ngFor="let tax of taxes" [value]="tax.code">{{tax.name}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <!-- ROW 4 -->
                                <div class="flex justify-between">
                                    <div class="flex flex-col">
                                        <div class="font-semibold">Price</div>
                                        <div class="font-semibold text-lg">{{ item.get('price').value | currency }}</div>
                                    </div>
                                    <div class="flex flex-col">
                                        <div class="font-semibold">Total</div>
                                        <div class="font-semibold text-lg">{{ item.get('total').value | currency }}</div>
                                    </div>
                                   
                                </div>
                                 <!-- ROW 4 -->
                                 <div class="flex justify-end">
                                    <button (click)="removeItemRowBtn(i)" mat-button>
                                        <mat-icon class="text-gray-400 icon-size-5" [svgIcon]="'heroicons_solid:trash'">
                                        </mat-icon>
                                    </button>
                                 </div>
                            </div>

                        </ng-container>
                    <!-- </ng-container> -->
            </div>
        </ng-template>


        <div class="text-center text-secondary md:mt-3" *ngIf="items.controls.length == 0">
            No hay artículos agregados a este pedido.
        </div>


    </div>
</div>

<!-- TOTALES-->
<div class="flex flex-col md:flex-row justify-between  gap-3 mt-5 flex-wrap-reverse">

    <!-- COMMENTS -->
    <div class="order-last md:order-first font-medium text-md pt-10 basis-1/2 ">
        <mat-form-field appearance="outline" class="w-full fuse-mat-dense">
            <textarea maxlength="250" placeholder="Comentarios..." [(ngModel)]="comments" matInput name="comments"
                id="comments" cols="10" rows="5"></textarea>
        </mat-form-field>
    </div>

    <!-- TOTAL SUMMARY -->
    <div class=" font-medium text-md text-left">
        <div class="grid gap-2 grid-cols-2 p-3">

            <div class="self-center font-medium tracking-tight text-secondary text-right">
                SUBTOTAL
            </div>
            <div class="text-right text-lg">{{subTotal | currency}}</div>

            <!-- DISCOUNT -->
            <ng-container *ngIf="discount > 0">
                <div class="self-center font-medium tracking-tight text-secondary text-right ">
                    DESCUENTO</div>
                <div class="text-right text-lg text-right">- {{discount | currency}}</div>
            </ng-container>

            <!-- TAXES -->
            <ng-container *ngFor="let tax of totalTaxes">
                <div class="self-center font-medium tracking-tight text-secondary text-right uppercase">
                    {{tax.name}}
                </div>
                <div class="text-right text-lg text-right"> {{tax.value | currency}}</div>
            </ng-container>


            <!-- Divider -->
            <div class="col-span-2 my-3 border-b"></div>

            <!-- Total -->
            <div class="self-center text-2xl font-medium tracking-tight text-secondary text-righ">
                TOTAL</div>
            <div class="text-right text-2xl font-medium text-righ">{{total | currency}}</div>
        </div>
    </div>


</div>